# 方案：架构收敛与可维护性提升

目标：在不改变产品能力的前提下，把“可维护性/可测试性/可观测性”拉到团队可持续迭代的水平；减少重复代码、减少耦合、明确边界。

## 1. 范围与原则

- 范围：Flutter 为主，web 为辅（依赖、启动、API 边界清晰化）。
- 原则：
  - 结构性重构必须配套“可验证的回归手段”（至少脚本/测试/手工回归清单）。
  - 分层清晰：UI/State/Domain/Infra。
  - 可观测：统一日志、错误分类、指标。

## 2. Flutter 侧架构演进方向

### 2.1 Networking：Dio Factory + Interceptor 统一

现状：
- `director_ai/lib/services/api_service.dart` 内创建多个 Dio：`_dio/_tuziDio/_imageDio/_doubaoDio`，配置高度重复。

方案：
- 新增（或在 services 下新增文件）`dio_factory.dart`：
  - `Dio create({required String baseUrl, required String Function() tokenProvider, Duration connectTimeout, ...})`
  - 安装统一拦截器：
    - Authorization 注入
    - 结构化日志（可开关）
    - 错误映射（429/5xx/timeout → 统一异常类型）

验收：
- ApiService 仅表达“业务 API”，不再关心 Dio 初始化细节。

### 2.2 Domain Error：把“错误字符串”升级为可处理的错误类型

现状：
- 错误多为 `Exception('...')` 或直接 `e.toString()`。

方案：
- 定义错误类型：
  - `NetworkError`（timeout, badStatus, rateLimit）
  - `ConfigError`（missing api key）
  - `ParseError`（LLM JSON/Screenplay parse）
  - `UserCancelled`

验收：
- UI 层展示可以根据类型做更友好提示（例如 rate limit 提示重试/等待）。

### 2.3 Logging：AppLogger 统一入口 + 级别开关

现状：
- `print/debugPrint` 与 `AppLogger` 混用。

方案：
- 建立规则：
  - 非 UI debug：必须用 `AppLogger`。
  - `AppLogger` 提供“runtime log level”开关（可从设置页控制）。

验收：
- grep 项目中不再出现业务层 `print/debugPrint`。

### 2.4 ReAct/Parsing：拆分 AgentController 的解析职责

现状：
- `director_ai/lib/controllers/agent_controller.dart` 同时包含流处理、UI 消息处理、JSON 提取策略。

方案：
- 新增 `lib/services/agent_command_parser.dart`：
  - 单一职责：从模型输出提取可解析的 JSON command。
  - 单元测试：输入样例（带 thinking/markdown/多 json）→ 输出 command。

验收：
- AgentController 变短，解析逻辑可测试。

### 2.5 数据一致性：Conversation metadata schema + 迁移策略

方案：
- 明确 ConversationMessage.metadata schema（文档化），例如：
  - `imageUrl`, `videoUrl`, `taskId`, `sceneId`...
- 兼容旧数据：读取时兼容老字段，写入用新字段。

验收：
- 不破坏已有历史数据；缓存命中率可观察。

## 3. Web 侧架构演进方向

### 3.1 依赖治理

- 引入 `requirements.lock` 或者 constraints 文件，避免上游破坏 import。
- 建议加一个 `Makefile` 统一命令：`make venv`, `make run`, `make lint`。

### 3.2 服务边界

- 明确 `web/` 是否是 Flutter 的 backend。
  - 如果不是：文档里明确“独立工具”，避免贡献者误解。
  - 如果是：需要定义 API auth/版本/契约，并考虑移动端的网络策略。

## 4. 执行步骤（里程碑）

M1（基础收敛）：
- Networking factory + 统一错误类型 + 日志规则落地。

M2（可测试性）：
- 抽出 parser + 给 parser 和 screenplay parser 加测试。

M3（可观测性/体验）：
- retry/backoff + 指标埋点（成功率、耗时、失败分布）。

## 5. 预估工作量

- M1：3-5 天（涉及核心服务改造，需要回归）
- M2：2-4 天
- M3：3-6 天

合计：8-15 天

## 6. 风险与缓解

- 重构范围大：必须分阶段合并，每阶段都可运行。
- 需要实际 API key 进行端到端回归：建议准备一个 staging key/假后端。

## 7. Done 标准

- 项目结构清晰，可快速定位：UI/Provider/Controller/Service。
- ApiService 变薄、Dio 初始化集中。
- 核心 parser 有测试。
- 日志和错误处理一致。
