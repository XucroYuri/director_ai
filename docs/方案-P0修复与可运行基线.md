# 方案：P0 修复与可运行基线

目标：用最小改动把当前 `director_ai` 做到“能稳定跑 + 能稳定改”，优先消除会阻断构建/运行或引发数据错误/泄密的风险点。

## 1. 范围与原则

- 范围：只做 P0 级别修复，不做结构性重构。
- 原则：
  - Fix minimally：只改导致错误或高风险的问题。
  - 可验证：每项修复必须有明确验收标准（构建/测试/手工验证步骤）。
  - 不引入新依赖（除非是 web 端“必须跑起来”的运行时依赖约束）。

## 2. 背景与当前问题摘要

来自 `docs/code-review.md` 的关键 P0：

1) Dart 侧疑似存在合并残留/硬错误：
- `director_ai/lib/services/api_service.dart` 中 `ApiConfig.createDio()` 出现两处定义。

2) 会话媒体缓存逻辑无法命中：
- `director_ai/lib/providers/conversation_provider.dart` 写 `metadata['mediaUrl']`，但缓存逻辑读 `metadata['imageUrl']`/`metadata['videoUrl']`。

3) Secrets 暴露风险：
- `director_ai/lib/services/api_config_service.dart` 在 set key 时打印 key 前缀。

4) web 侧运行脆弱：
- 代理环境变量导致 `httpx` socks 依赖缺失。
- `huggingface_hub` 版本与 Gradio 期望 API 不一致。

## 3. 交付物（Deliverables）

- Flutter：
  - 修复 `ApiConfig.createDio()` 重复定义，确保 Flutter 编译通过。
  - 修复 Conversation metadata 键一致性，让缓存逻辑生效。
  - 禁止日志输出任何 API key（包括前缀）。

- Web：
  - 给出“已验证可用”的 Python 依赖约束方案（例如 pin 版本 / constraints）。
  - 在文档中写清楚代理环境下如何运行。

## 4. 具体改动清单（按优先级）

### 4.1 修复 `ApiConfig.createDio()` 重复定义（P0）

问题定位：
- `director_ai/lib/services/api_service.dart` 存在两处 `static Dio createDio()`。

建议方案：
- 保留“动态 header 注入”的版本（通过拦截器在 onRequest 设置 Authorization），删除或改名另一份。

验收标准：
- `flutter analyze` 无编译错误。
- `flutter test`（如有）通过。

风险与回滚：
- 风险：不同 createDio 实现导致 Authorization 注入时机变化。
- 回滚：保留另一实现为 `createZhipuDioLegacy()`（仅临时），确保可对比。

### 4.2 修复会话 metadata key 不一致（P0）

问题定位：
- 写入：`ConversationProvider.saveMessage()` 写 `metadata: {'mediaUrl': ...}`。
- 读取：`ConversationProvider._cacheMessageMedia()` 读 `imageUrl`/`videoUrl`。

建议方案（推荐）：
- 在保存消息时按消息类型写入明确字段：
  - 图片：`imageUrl`
  - 视频：`videoUrl`
  - 同时可保留 `mediaUrl` 作为兼容字段，但读逻辑必须兼容。

验收标准：
- 发送图片/视频消息后，缓存目录出现对应文件（或缓存统计变化）。
- 不影响已有历史消息读取。

### 4.3 移除/收敛敏感日志（P0）

问题定位：
- `director_ai/lib/services/api_config_service.dart` set key 时打印 key substring。

建议方案：
- 日志仅记录“更新了哪个 key”，不要输出任何部分内容。

验收标准：
- 全局 grep：不存在 `substring(0, 8)` 这类 key 前缀日志。
- 运行设置页面更新 key，日志不出现 key 内容。

### 4.4 Web 端可运行性补丁（P0）

问题定位：
- 代理环境变量（socks/http）影响 import。
- `huggingface_hub` 与 Gradio 兼容性。

建议方案：
- 不直接改业务代码，先做依赖层“钉死”：
  - `huggingface_hub<1.0`
  - `httpx[socks]`
- 进一步建议（P1）：引入 lockfile（见方案 2/3）。

验收标准：
- `python -c "import app"` 在代理环境下也可执行（或文档明确要求 unset proxy）。

## 5. 执行步骤（建议顺序）

1) Flutter：修复 createDio 重复定义，跑 `flutter analyze`。
2) Flutter：修复 metadata keys，做一次消息缓存验证。
3) Flutter：清理 secrets 日志。
4) Web：补齐依赖约束 + 文档化代理注意事项。

## 6. 预估工作量

- 0.5 天：定位 + 修复 createDio 重复定义 + analyze。
- 0.5 天：修复 metadata keys + 手工验证。
- 0.5 天：日志清理 + 搜索回归。
- 0.5 天：web 依赖约束 + 文档补齐。

总计：约 2 天（偏保守）。

## 7. 风险清单

- Flutter 侧：ApiService/ApiConfig 涉及多服务，改动需要避免影响 token 注入。
- Web 侧：Gradio 依赖变动快，最好加 lockfile 或容器化。

## 8. 退出条件（Definition of Done）

- Flutter：分析无错误，核心流程能跑通（至少 UI 启动 + 配置 key + 发起一次请求）。
- Web：能 `import app` 且可 `python app.py` 启动到端口（至少本机）。
